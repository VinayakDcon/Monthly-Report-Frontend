<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RFQ Analytics Dashboard</title>
    <link rel="stylesheet" href="./style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>ðŸ“Š RFQ Analytics Dashboard</h2>

<!-- KPI CARDS -->
<div class="summary">
    <div class="card">
        <h4>Total RFQs</h4>
        <p id="total-rfqs"></p>
    </div>
    <div class="card">
        <h4>Customers</h4>
        <p id="customers"></p>
    </div>
    <div class="card">
        <h4>Converted Projects</h4>
        <p id="converted-projects"></p>
    </div>
    <div class="card highlight">
        <h4>Conversion Rate</h4>
        <p id="conversion-rate"></p>
    </div>
</div>

<!-- CHARTS -->
<div class="charts">
    <div class="chart-box">
        <h4>RFQs by Status</h4>
        <canvas id="statusChart"></canvas>
    </div>

    <div class="chart-box">
        <h4>RFQ Funnel</h4>
        <canvas id="funnelChart"></canvas>
    </div>

    <div class="chart-box">
        <h4>Top Customers by RFQs</h4>
        <canvas id="customerChart"></canvas>
    </div>
</div>

<hr>

<h3 style="margin-top:30px;">ðŸ“‹ All RFQs</h3>

<a href="./add_rfq.html" class="btn">+ Add RFQ</a>
<a href="https://api.yourdomain.com/download-rfq" class="btn">Download Excel</a>

<table class="rfq-table">
    <thead>
        <tr>
            <th>RFQ ID</th>
            <th>Customer</th>
            <th>Status</th>
            <th>Feasibility</th>
            <th>Quote</th>
            <th>Outcome</th>
            <th>Owner</th>
            <th>Action</th>
        </tr>
    </thead>
    <tbody id="rfq-table-body"></tbody>
</table>

<script>
const API_BASE = "https://api.yourdomain.com";

fetch(`${API_BASE}/rfq-dashboard`)
    .then(res => res.json())
    .then(data => {
        /* ================= KPI ================= */
        document.getElementById("total-rfqs").innerText = data.summary.total_rfqs;
        document.getElementById("customers").innerText = data.summary.customers;
        document.getElementById("converted-projects").innerText = data.summary.converted_projects;
        document.getElementById("conversion-rate").innerText = data.summary.conversion_rate + "%";

        /* ================= TABLE ================= */
        const tbody = document.getElementById("rfq-table-body");
        tbody.innerHTML = "";

        data.table_data.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${row.RFQ_ID}</td>
                <td>${row.Customer}</td>
                <td>${row.Status}</td>
                <td>${row.Feasibility_Completed}</td>
                <td>${row.Quote_Submitted}</td>
                <td>${row.Outcome}</td>
                <td>${row.Responsible}</td>
                <td>
                    <a href="./edit_rfq.html?rfq_id=${row.RFQ_ID}">Edit</a>
                    <button style="color:red;" onclick="deleteRFQ('${row.RFQ_ID}')">Delete</button>
                </td>
            `;
            tbody.appendChild(tr);
        });

        /* ================= CHARTS ================= */
        renderCharts(data);
    });

function deleteRFQ(rfqId) {
    if (!confirm("Are you sure you want to delete this RFQ?")) return;

    fetch(`${API_BASE}/delete-rfq/${rfqId}`, { method: "DELETE" })
        .then(res => {
            if (!res.ok) throw new Error();
            location.reload();
        });
}

function renderCharts(data) {

    /* RFQs BY STATUS */
    const statusLabels = Object.keys(data.status_counts);
    const statusValues = Object.values(data.status_counts);

    const wonData = statusLabels.map(label =>
        label.toLowerCase() === "closed" ? data.closed_won : 0
    );

    new Chart(document.getElementById("statusChart"), {
        type: "bar",
        data: {
            labels: statusLabels,
            datasets: [
                { label: "Total", data: statusValues },
                { label: "Won (inside Closed)", data: wonData }
            ]
        },
        options: { indexAxis: "y", scales: { x: { stacked: true }, y: { stacked: true } } }
    });

    /* RFQ FUNNEL */
    new Chart(document.getElementById("funnelChart"), {
        type: "bar",
        data: {
            labels: ["Total RFQs", "Feasibility Completed", "Quote Submitted", "Converted"],
            datasets: [{
                data: [
                    data.summary.total_rfqs,
                    data.funnel.feasibility,
                    data.funnel.quote,
                    data.summary.converted_projects
                ]
            }]
        },
        options: { plugins: { legend: { display: false } } }
    });

    /* TOP CUSTOMERS */
    new Chart(document.getElementById("customerChart"), {
        type: "bar",
        data: {
            labels: Object.keys(data.top_customers),
            datasets: [{ data: Object.values(data.top_customers) }]
        },
        options: { indexAxis: "y", plugins: { legend: { display: false } } }
    });
}
</script>

</body>
</html>
